<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Account Mu Hunter Panel</title>

  <script>document.documentElement.classList.add('dark');</script>

  <!-- Tailwind via CDN (ok para GitHub Pages; em produ√ß√£o real use build/CLI) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>

  <!-- Supabase JS v2 -->
  <script type="module" crossorigin src="https://esm.sh/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===== Layout ===== */
    .mh-center-wrap{position:relative;}
    .mh-side{width:320px; position:absolute; top:0;}
    .mh-side-left{left:0; transform:translateX(calc(-100% - 1.5rem));}
    .mh-side-right{right:0; transform:translateX(calc(100% + 1.5rem));}
    @media (max-width: 1279px){ .mh-side{display:none;} }

    /* ===== UI ===== */
    .title-gradient{
      background: linear-gradient(90deg,#a78bfa,#60a5fa 35%,#34d399 70%,#f472b6);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .glass{backdrop-filter:saturate(180%) blur(6px); background-color:rgba(24,24,27,.5);}

    .switch{position:relative;display:inline-block;width:44px;height:24px;}
    .switch input{opacity:0;width:0;height:0;}
    .slider{position:absolute;cursor:pointer;inset:0;background-color:#3f3f46;transition:.2s;border-radius:9999px;}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.2s;border-radius:9999px;}
    input:checked + .slider{background-color:#10b981;}
    input:checked + .slider:before{transform:translateX(20px);}

    th.sortable{cursor:pointer;user-select:none;}
    th.sortable .hint{opacity:.6;font-size:12px;margin-left:4px;}

    .cbfx{
      appearance:none;-webkit-appearance:none;
      width:22px;height:22px;
      border:1px solid rgb(255,70,70);
      border-radius:3px;
      background:transparent;
      cursor:pointer;
      transition:background-color .15s ease, transform .12s ease;
    }
    .cbfx:active{transform:scale(.95);}
    .cbfx:checked{background-color:rgb(255,70,70);border-color:rgb(255,70,70);}
    .cbfx:checked::after{
      content:"";
      position:relative;
      display:block;
      width:10px;height:5px;
      margin:5px auto 0;
      border:2px solid #fff;border-top:0;border-right:0;
      transform:rotate(-45deg);
    }

    .iconbtn{
      display:inline-flex;align-items:center;justify-content:center;
      width:26px;height:26px;border-radius:8px;
      background:#3f3f46;color:#e4e4e7;border:1px solid #27272a;
    }
    .iconbtn:hover{background:#52525b;}
    .icon{width:16px;height:16px;display:block;}

    .tagbox{width:16ch;text-transform:uppercase;}

    /* ===== Cards dos gr√°ficos (preenchimento uniforme) ===== */
    .mh-sidecard{min-height:440px;padding-bottom:1.25rem;}
    .chart-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;}
    .chart-legend{
      margin-top:14px;
      width:100%;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px 10px;
      font-size:10px;
      color:#e4e4e7;
    }
    .chart-legend-item{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chart-legend-color{
      width:28px;height:8px;border-radius:2px;border:2px solid #000;flex-shrink:0;
    }
  
    /* ===== Kin button states + spinner + highlights ===== */
    .kinBtn{ transition: background-color .18s ease, transform .12s ease; }
    .kinBtn[data-open="1"]{ background:#2563eb; }
    .kinBtn.loading{ background:#16a34a; opacity: .95; }
    .kinBtn.loading svg{ display:block; }
    @keyframes mhspin{ to{ transform: rotate(360deg); } }
    .mh-spin{ animation: mhspin .8s linear infinite; }
    mark.mh-hl{ background: rgba(34,197,94,.20); color: #e4e4e7; padding: 0 .12rem; border-radius: .25rem; }

</style>
</head>

<body class="bg-zinc-950 text-zinc-100 min-h-screen">
  <div id="app" class="max-w-7xl mx-auto p-4">
    <!-- Header -->
    <header class="mb-6">
      <div class="rounded-2xl glass border border-zinc-800 p-6 text-center shadow">
        <div class="flex items-center justify-between">
          <div class="w-12"></div>
          <div>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight title-gradient">Account Mu Hunter Panel</h1>
            <p class="mt-2 text-sm text-zinc-400">gerencie status, tags e controles em tempo real</p>
          </div>
          <button id="logoutBtn" class="px-3 py-1.5 rounded-xl bg-red-500 text-white hidden hover:bg-red-600 transition">Sair</button>
        </div>
      </div>
    </header>

    <!-- Login -->
    <section id="authCard" class="max-w-md mx-auto mt-8 bg-zinc-900 border border-zinc-800 shadow rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">Entrar</h2>
      <div class="space-y-3">
        <label class="block">
          <span class="text-sm text-zinc-300">E-mail</span>
          <input id="email" type="email" class="mt-1 w-full rounded-xl border border-zinc-800 bg-zinc-950 px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-700" />
        </label>
        <label class="block">
          <span class="text-sm text-zinc-300">Senha</span>
          <input id="password" type="password" class="mt-1 w-full rounded-xl border border-zinc-800 bg-zinc-950 px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-700" />
        </label>
        <button id="loginBtn" class="w-full py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-500 transition">Entrar</button>
        <p id="authMsg" class="text-sm text-red-400 hidden"></p>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="hidden">
      <div class="max-w-7xl mx-auto px-2 mh-center-wrap">

        <!-- ESQUERDA -->
        <aside class="mh-side mh-side-left hidden xl:block">
          <div class="w-[320px] shrink-0">
            <div class="p-4 rounded-2xl bg-zinc-900 border border-zinc-800 shadow flex flex-col mh-sidecard">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm text-zinc-300 font-semibold">Modifica√ß√µes por usu√°rio</h3>
                <span class="text-xs text-zinc-500" id="pieTotalEditsLbl">‚Äì</span>
              </div>
              <div class="chart-wrap">
                <canvas id="userEditsPie" width="260" height="260"></canvas>
                <div id="userLegend" class="chart-legend"></div>
              </div>
            </div>
          </div>
        </aside>

        <!-- CENTRO -->
        <main class="min-w-0">
          <!-- Filtros -->
          <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-4 items-end">
            <div class="md:col-span-7 flex flex-col">
              <label class="text-sm text-zinc-300 h-5">Busca (username ou senha)</label>
              <input id="search"
                class="mt-1 w-full h-10 rounded-xl border border-zinc-800 bg-zinc-950 px-3 outline-none focus:ring-2 focus:ring-zinc-700"
                placeholder="ex: andrefirme" />
            </div>

            <div class="md:col-span-3 flex flex-col">
              <label class="text-sm text-zinc-300 h-5">Apenas V√°lidas (f3='valid')</label>
              <select id="validFilter"
                class="mt-1 w-full h-10 rounded-xl border border-zinc-800 bg-zinc-950 px-3 outline-none focus:ring-2 focus:ring-zinc-700">
                <option value="">N√£o</option>
                <option value="yes">Sim</option>
              </select>
            </div>

            <input type="hidden" id="timeRange" value="all"/>

            <div class="md:col-span-2 flex flex-col">
              <div class="h-5"></div>
              <div class="mt-1 grid grid-cols-2 gap-2">
                <button id="applyBtn" class="px-3 py-2 h-10 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition w-full">Aplicar</button>

                <div class="relative">
                  <button id="recentBtn"
                    type="button"
                    class="px-3 py-2 h-10 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 transition w-full flex items-center justify-between gap-2 text-sm whitespace-nowrap">
                    <span id="recentLabel" class="text-left">Recentes</span>
                    <span class="text-xs">üïí</span>
                  </button>

                  <div id="recentMenu"
                    class="hidden absolute right-0 mt-2 w-44 rounded-xl border border-zinc-800 bg-zinc-950 shadow-lg z-50 overflow-hidden">
                    <button type="button" class="w-full text-left px-3 py-2 hover:bg-zinc-900 text-sm" data-range="24h">√öltimas 24h</button>
                    <button type="button" class="w-full text-left px-3 py-2 hover:bg-zinc-900 text-sm" data-range="7d">√öltimos 7 dias</button>
                    <button type="button" class="w-full text-left px-3 py-2 hover:bg-zinc-900 text-sm" data-range="30d">√öltimos 30 dias</button>
                    <button type="button" class="w-full text-left px-3 py-2 hover:bg-zinc-900 text-sm" data-range="all">Todo per√≠odo</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cards -->
          <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-4 items-stretch">
            <div class="md:col-span-3 p-4 rounded-2xl bg-zinc-900 border border-zinc-800 shadow">
              <div class="text-sm text-zinc-400">Total filtrado</div>
              <div id="cardTotal" class="text-2xl font-bold">0</div>
            </div>
            <div class="md:col-span-3 p-4 rounded-2xl bg-zinc-900 border border-zinc-800 shadow">
              <div class="text-sm text-zinc-400">Online (ligado)</div>
              <div id="cardOnline" class="text-2xl font-bold">0</div>
            </div>
            <div class="md:col-span-3 p-4 rounded-2xl bg-zinc-900 border border-zinc-800 shadow">
              <div class="text-sm text-zinc-400">V√°lidas</div>
              <div id="cardValid" class="text-2xl font-bold">0</div>
            </div>
            <div class="md:col-span-3 p-4 rounded-2xl bg-zinc-900 border border-zinc-800 shadow">
              <div class="text-sm text-zinc-400">Soma WCoin</div>
              <div id="cardWSum" class="text-2xl font-bold">0</div>
            </div>
          </div>

          <!-- Tabela -->
          <div class="overflow-auto rounded-2xl shadow ring-1 ring-black/20">
            <table class="min-w-full text-sm">
              <thead class="bg-zinc-900 border-b border-zinc-800">
                <tr>
                  <th class="text-left px-3 py-2">Usu√°rio</th>
                  <th class="text-left px-3 py-2">Senha</th>
                  <th class="text-left px-3 py-2 sortable" id="thWcoin">WCoin <span class="hint" id="hintW">‚áÖ</span></th>
                  <th class="text-left px-3 py-2 sortable" id="thOnline">Online <span class="hint" id="hintO">‚áÖ</span></th>
                  <th class="text-left px-3 py-2 sortable" id="thFlag">Itens Pegar <span class="hint" id="hintF">‚áÖ</span></th>
                  <th class="text-center px-2 py-2 w-14 sortable" id="thOlhar">Rapelado <span class="hint" id="hintOlhar">‚áÖ</span></th>
                  <th class="text-center px-2 py-2 w-12">S1</th>
                  <th class="text-center px-2 py-2 w-12">S2</th>
                  <th class="text-center px-2 py-2 w-12">S3</th>
                  <th class="text-center px-2 py-2 w-12">S4</th>
                  <th class="text-center px-2 py-2 w-12">S5</th>
                  <th class="text-center px-2 py-2 w-12">S6</th>
                  <th class="text-center px-2 py-2 w-12">S7</th>
                  <th class="text-center px-3 py-2">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="rows" class="divide-y divide-zinc-800 bg-zinc-950"></tbody>
            </table>
          </div>

          <div class="flex items-center gap-2 mt-4">
            <button id="prevBtn" class="px-3 py-1.5 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition">‚óÄ</button>
            <span id="pageLbl" class="text-sm text-zinc-400">P√°gina 1</span>
            <button id="nextBtn" class="px-3 py-1.5 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition">‚ñ∂</button>
            <select id="limitSel" class="ml-4 px-2 py-1.5 rounded-xl bg-zinc-800 hover:bg-zinc-700 transition">
              <option>25</option>
              <option selected>50</option>
              <option>100</option>
            </select>
          </div>
        </main>

        <!-- DIREITA -->
        <aside class="mh-side mh-side-right hidden xl:block">
          <div class="w-[320px] shrink-0">
            <div class="p-4 rounded-2xl bg-zinc-900 border border-zinc-800 shadow flex flex-col mh-sidecard">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm text-zinc-300 font-semibold">Status das contas</h3>
                <span class="text-xs text-zinc-500" id="statusTotalLbl">‚Äì</span>
              </div>

              <div class="chart-wrap">
                <canvas id="statusPie" width="260" height="260"></canvas>
                <div id="statusLegend" class="chart-legend"></div>
              </div>

              <div class="mt-3 text-center text-xs text-zinc-500">Total v√°lidas sem nenhuma marca√ß√£o</div>
              <div class="mt-1 text-center text-lg font-bold" id="validasLimpasLbl">0</div>
            </div>
          </div>
        </aside>

      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const ICON_COPY_SVG = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';

    const ICON_KIN_SVG = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>';
    const ICON_SPIN_SVG = '<svg class="icon animate-spin" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-opacity="0.25" stroke-width="3"/><path d="M21 12a9 9 0 0 0-9-9" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>';


    // ========= CONFIG =========
    const SUPABASE_URL = "https://uwcyvobwgcdyyphafofy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3Y3l2b2J3Z2NkeXlwaGFmb2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDIyMzQsImV4cCI6MjA3NzE3ODIzNH0.YTDIIZ5AzwyhDASO15vexglhvTX4ZMqoZksZh3PPEH89";
    const TABLE = "webzen_cache_raw";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage }
    });

    // ========= ELEMENTOS =========
    const authCard = document.getElementById('authCard');
    const dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const authMsg = document.getElementById('authMsg');

    const searchEl = document.getElementById('search');
    const validFilterEl = document.getElementById('validFilter');
    const applyBtn = document.getElementById('applyBtn');

    const timeRangeEl = document.getElementById('timeRange');
    const recentBtn = document.getElementById('recentBtn');
    const recentMenu = document.getElementById('recentMenu');
    const recentLabel = document.getElementById('recentLabel');

    const rowsEl = document.getElementById('rows');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageLbl = document.getElementById('pageLbl');
    const limitSel = document.getElementById('limitSel');

    const cardTotal = document.getElementById('cardTotal');
    const cardOnline = document.getElementById('cardOnline');
    const cardValid = document.getElementById('cardValid');
    const cardWSum = document.getElementById('cardWSum');

    const thWcoin = document.getElementById('thWcoin');
    const thOnline = document.getElementById('thOnline');
    const thFlag = document.getElementById('thFlag');
    const thOlhar = document.getElementById('thOlhar');

    const hintW = document.getElementById('hintW');
    const hintO = document.getElementById('hintO');
    const hintF = document.getElementById('hintF');
    const hintOlhar = document.getElementById('hintOlhar');

    // ========= CHARTS STATE =========
    const userPieCanvas = document.getElementById('userEditsPie');
    const pieTotalEditsLbl = document.getElementById('pieTotalEditsLbl');
    const userLegend = document.getElementById('userLegend');
    let userChart = null;
    let lastUserRows = []; // [{label, value}]
    let currentUserEmail = null;

    const statusCanvas = document.getElementById('statusPie');
    const statusTotalLbl = document.getElementById('statusTotalLbl');
    const validasLimpasLbl = document.getElementById('validasLimpasLbl');
    const statusLegend = document.getElementById('statusLegend');
    let statusChart = null;
    let lastStatusReal = { online: 0, itens: 0, rapelado: 0, validas: 0 };

    // ========= APP STATE =========
    let page = 1;
    let sort = { field: 'inserted_at', asc: false };

    // ========= HELPERS =========
    const fmt = (n)=> Number(n||0).toLocaleString('pt-BR');

    function rangeCutoffISO(val){
      const now = new Date();
      if(val==='24h') now.setHours(now.getHours()-24);
      else if(val==='7d') now.setDate(now.getDate()-7);
      else if(val==='30d') now.setDate(now.getDate()-30);
      else return null;
      return now.toISOString();
    }

    function baseSelect(){
      return supabase.from(TABLE).select('id, f1, f2, f3, wcoin_int, online, s1, s2, s3, s4, s5, s6, s7, flag, tag4, olhar, inserted_at');
    }

    function applyFilters(q){
      const s = (searchEl?.value || '').trim();
      const valid = validFilterEl?.value || '';

      const cutoff = rangeCutoffISO(timeRangeEl?.value || 'all');
      if(cutoff) q = q.gte('inserted_at', cutoff);

      if (s) q = q.or(`f1.ilike.%${s}%,f2.ilike.%${s}%`);
      if (valid === 'yes') q = q.eq('f3', 'valid');

      q = q.not('f1', 'like', '%/%');
      q = q.not('f2', 'like', '%/%');
      return q;
    }

    function applySort(q){
      if (sort.field === 'wcoin_int') q = q.order('wcoin_int', { ascending: sort.asc, nullsFirst: false });
      else if (sort.field === 'online') q = q.order('online', { ascending: !sort.asc });
      else if (sort.field === 'flag') q = q.order('flag', { ascending: !sort.asc });
      else if (sort.field === 'olhar') q = q.order('olhar', { ascending: !sort.asc });
      else if (sort.field === 'inserted_at') q = q.order('inserted_at', { ascending: sort.asc });
      else q = q.order('id', { ascending: false });
      return q;
    }

    function formatDate(ts){
      if(!ts) return '';
      const d = new Date(ts);
      if(isNaN(d.getTime())) return '';
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm} ${hh}:${mi}`;
    }

    function boolFromData(v){ return v === '1' || v === 'true' || v === true; }

    // ---------- PARENTESCO (kinship) ----------
    function normStr(s){
      return (s || '').toString().toLowerCase().replace(/[^a-z0-9]/g,'');
    }
    function buildTokensFrom(...parts){
      const pushUnique = (arr, t) => { if(t && !arr.includes(t)) arr.push(t); };

      const tokens = [];
      const takeWindows = (seq) => {
        const s = seq;
        const L = s.length;
        const lens = [6,5,4]; // mais espec√≠fico
        for(const k of lens){
          if(L < k) continue;
          pushUnique(tokens, s.slice(0,k));
          pushUnique(tokens, s.slice(Math.max(0, Math.floor((L-k)/2)), Math.max(0, Math.floor((L-k)/2))+k));
          pushUnique(tokens, s.slice(L-k));
        }
      };

      const normParts = parts
        .filter(Boolean)
        .map(p => String(p).trim().toLowerCase())
        .filter(Boolean);

      // pega as maiores sequ√™ncias alfanum√©ricas (evita tokens muito curtos)
      const seqs = [];
      for(const p of normParts){
        const found = (p.match(/[a-z0-9]{6,}/g) || []);
        for(const s of found) seqs.push(s);
      }

      // prioriza as maiores (mais fortes)
      seqs.sort((a,b)=> b.length - a.length);

      // usa poucas sequ√™ncias (reduz ru√≠do)
      for(const s of seqs.slice(0, 4)){
        takeWindows(s);
        if(tokens.length >= 8) break;
      }

      return tokens.slice(0, 8);
    }
    
    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, (ch)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[ch]));
    }
    function highlightText(val, tokens){
      const safe = escapeHtml(val);
      const toks = (tokens || []).slice().sort((a,b)=> b.length - a.length);
      const low = safe.toLowerCase();
      for(const t of toks){
        const tl = String(t).toLowerCase();
        if(tl.length < 6) continue;
        const i = low.indexOf(tl);
        if(i >= 0){
          const before = safe.slice(0,i);
          const mid = safe.slice(i, i+tl.length);
          const after = safe.slice(i+tl.length);
          return `${before}<mark class="mh-hl">${mid}</mark>${after}`;
        }
      }
      return safe;
    }

function buildKinOrClause(tokens){
      const parts = [];
      (tokens || []).forEach(t=>{
        parts.push(`f1.ilike.%${t}%`);
        parts.push(`f2.ilike.%${t}%`);
      });
      return parts.join(',');
    }
    function kinColspan(){
      // total columns in main table
      return 14;
    }

    function renderKinTable(items, tokens){
      const smallHead = `
        <div class="text-xs text-zinc-400 mb-2 flex items-center justify-between">
          <span>Parentesco (login/senha parecidos)</span>
          <span class="text-zinc-500">${(items?.length||0)} resultados</span>
        </div>
      `;
      const header = `
        <table class="min-w-full text-xs">
          <thead class="bg-zinc-900/70 border-b border-zinc-800">
            <tr>
              <th class="text-left px-2 py-1.5">Usu√°rio</th>
              <th class="text-left px-2 py-1.5">Senha</th>
              <th class="text-left px-2 py-1.5">WCoin</th>
              <th class="text-left px-2 py-1.5">Online</th>
              <th class="text-left px-2 py-1.5">Itens</th>
              <th class="text-center px-2 py-1.5">Rap</th>
              <th class="text-center px-1 py-1.5">S1</th>
              <th class="text-center px-1 py-1.5">S2</th>
              <th class="text-center px-1 py-1.5">S3</th>
              <th class="text-center px-1 py-1.5">S4</th>
              <th class="text-center px-1 py-1.5">S5</th>
              <th class="text-center px-1 py-1.5">S6</th>
              <th class="text-center px-1 py-1.5">S7</th>
              <th class="text-center px-2 py-1.5">A√ß√µes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-zinc-800 bg-zinc-950/40">
            ${(items||[]).map(r => {
              const sCells = [1,2,3,4,5,6,7].map(n =>
                `<td class="px-1 py-1 text-center"><input type="checkbox" class="sChk cbfx" data-s="${n}" ${r['s'+n] ? 'checked' : ''}/></td>`
              ).join('');
              return `
                <tr class="hover:bg-zinc-900/50 transition" data-id="${r.id}"
                    data-f3="${(r.f3 ?? '')}"
                    data-online="${r.online ? '1':'0'}"
                    data-flag="${r.flag ? '1':'0'}"
                    data-olhar="${r.olhar ? '1':'0'}"
                    data-tag4="${(r.tag4 ?? '')}"
                    data-s1="${r.s1 ? '1':'0'}" data-s2="${r.s2 ? '1':'0'}" data-s3="${r.s3 ? '1':'0'}"
                    data-s4="${r.s4 ? '1':'0'}" data-s5="${r.s5 ? '1':'0'}" data-s6="${r.s6 ? '1':'0'}" data-s7="${r.s7 ? '1':'0'}">
                  <td class="px-2 py-1 whitespace-nowrap">
                    <div class="flex items-center gap-2">
                      <span class="text-[10px] text-zinc-500">${formatDate(r.inserted_at)}</span>
                      <span class="text-zinc-600">‚îä</span>
                      <span class="uval">${highlightText(r.f1 ?? '', tokens)}</span>
                      <button class="iconbtn copyUserBtn" title="Copiar usu√°rio" data-copy="${escapeHtml(String(r.f1 ?? ''))}">${ICON_COPY_SVG}</button>
                    </div>
                  </td>
                  <td class="px-2 py-1 whitespace-nowrap">
                    <div class="flex items-center gap-2">
                      <span class="pval">${highlightText(r.f2 ?? '', tokens)}</span>
                      <button class="iconbtn copyPassBtn" title="Copiar senha" data-copy="${escapeHtml(String(r.f2 ?? ''))}">${ICON_COPY_SVG}</button>
                    </div>
                  </td>
                  <td class="px-2 py-1 whitespace-nowrap">${(r.wcoin_int ?? 0)}</td>
                  <td class="px-2 py-1 whitespace-nowrap">
                    <label class="switch">
                      <input type="checkbox" class="onlineToggle" ${r.online ? 'checked' : ''}>
                      <span class="slider"></span>
                    </label>
                  </td>
                  <td class="px-2 py-1 whitespace-nowrap">
                    <div class="flex items-center gap-2">
                      <label class="switch">
                        <input type="checkbox" class="flagToggle" ${r.flag ? 'checked' : ''}>
                        <span class="slider"></span>
                      </label>
                      <input class="tagInput tagbox rounded border border-zinc-800 bg-zinc-950 px-1.5 py-1 outline-none focus:ring-2 focus:ring-zinc-700"
                             maxlength="16" value="${r.tag4 ? r.tag4 : ''}" placeholder="TAG">
                    </div>
                  </td>
                  <td class="px-2 py-1 text-center"><input type="checkbox" class="olharToggle cbfx" ${r.olhar ? 'checked' : ''}/></td>
                  ${sCells}
                  <td class="px-2 py-1 whitespace-nowrap text-center">
                    <button class="delBtn px-2 py-1 rounded-xl bg-red-600 hover:bg-red-700 transition text-xs">Excluir</button>
                  </td>
                </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
      return smallHead + header;
    }

    async function fetchKinshipForRow(parent){
      // Gera poucos tokens (mais fortes) para reduzir "parentesco distante"
      const tokens = buildTokensFrom(parent.f1 || '', parent.f2 || '');
      if(!tokens.length) return { items: [], tokens: [] };

      const orClause = buildKinOrClause(tokens);

      // busca moderada (n√£o traz o mundo inteiro)
      let q = supabase.from(TABLE)
        .select('id, f1, f2, f3, wcoin_int, online, s1, s2, s3, s4, s5, s6, s7, flag, tag4, olhar, inserted_at')
        .or(orClause)
        .neq('id', parent.id)
        .limit(60);

      const { data, error } = await q;
      if(error){
        console.warn('kinship error:', error.message);
        return { items: [], tokens };
      }

      // Filtra localmente por for√ßa do match:
      // - pelo menos 2 tokens batendo, OU 1 token bem longo (>=8)
      const toks = tokens.slice();
      const minStrong = toks.some(t => t.length >= 8);

      const items = (data || []).filter(r=>{
        const s1 = String(r.f1 || '').toLowerCase();
        const s2 = String(r.f2 || '').toLowerCase();
        let hits = 0;
        let bestLen = 0;
        for(const t of toks){
          const tl = t.toLowerCase();
          if(s1.includes(tl) || s2.includes(tl)){
            hits++;
            if(t.length > bestLen) bestLen = t.length;
          }
        }
        if(bestLen >= 7) return true;
        if(hits >= 3) return true;
        if(hits >= 2 && bestLen >= 5) return true;
        return false;
      }).slice(0, 80);

      return { items, tokens };
    }

    async function toggleKinshipRow(parentTr){
      const parentId = parentTr.getAttribute('data-id');
      const btn = parentTr.querySelector('.kinBtn');
      const next = parentTr.nextElementSibling;

      // Fechar se j√° estiver aberto
      if(next && next.classList.contains('kinshipRow') && next.getAttribute('data-parent') === parentId){
        next.remove();
        if(btn){ btn.dataset.open = '0'; btn.classList.remove('loading'); btn.innerHTML = ICON_KIN_SVG; }
        return;
      }

      // remove qualquer parentesco aberto logo abaixo deste
      if(next && next.classList.contains('kinshipRow')) next.remove();

      // Marca como aberto + loading
      if(btn){
        btn.dataset.open = '1';
        btn.classList.add('loading');
        btn.innerHTML = ICON_SPIN_SVG;
      }

      const holder = document.createElement('tr');
      holder.className = 'kinshipRow';
      holder.setAttribute('data-parent', parentId);
      holder.innerHTML = `
        <td colspan="${kinColspan()}" class="px-3 py-3 bg-zinc-950/60">
          <div class="text-sm text-zinc-400">Buscando parentesco...</div>
        </td>
      `;
      parentTr.insertAdjacentElement('afterend', holder);

      // pega dados do parent no DOM (j√° renderizados)
      const parent = {
        id: parentId,
        f1: parentTr.querySelector('.uval')?.textContent || '',
        f2: parentTr.querySelector('.pval')?.textContent || '',
      };

      const { items, tokens } = await fetchKinshipForRow(parent);

      if(btn){ btn.classList.remove('loading'); btn.innerHTML = ICON_KIN_SVG; }

      holder.innerHTML = `
        <td colspan="${kinColspan()}" class="px-3 py-3 bg-zinc-950/60 rounded-b-2xl">
          ${items.length ? renderKinTable(items, tokens) : '<div class="text-sm text-zinc-500">Nenhum parentesco encontrado.</div>'}
        </td>
      `;
    }

    function getRowStateFromTr(tr){
      return {
        f3: tr.getAttribute('data-f3') || '',
        online: boolFromData(tr.getAttribute('data-online')),
        flag: boolFromData(tr.getAttribute('data-flag')),
        olhar: boolFromData(tr.getAttribute('data-olhar')),
        tag4: tr.getAttribute('data-tag4') || '',
        s1: boolFromData(tr.getAttribute('data-s1')),
        s2: boolFromData(tr.getAttribute('data-s2')),
        s3: boolFromData(tr.getAttribute('data-s3')),
        s4: boolFromData(tr.getAttribute('data-s4')),
        s5: boolFromData(tr.getAttribute('data-s5')),
        s6: boolFromData(tr.getAttribute('data-s6')),
        s7: boolFromData(tr.getAttribute('data-s7')),
      };
    }

    function applyRowStateToTr(tr, st){
      tr.setAttribute('data-f3', st.f3 || '');
      tr.setAttribute('data-online', st.online ? '1':'0');
      tr.setAttribute('data-flag', st.flag ? '1':'0');
      tr.setAttribute('data-olhar', st.olhar ? '1':'0');
      tr.setAttribute('data-tag4', (st.tag4 || ''));
      for(let i=1;i<=7;i++) tr.setAttribute('data-s'+i, st['s'+i] ? '1':'0');
    }

    function isValidasLimpas(st){
      const tagEmpty = !st.tag4 || String(st.tag4).trim().length === 0;
      return !st.online && !st.flag && !st.olhar &&
             !st.s1 && !st.s2 && !st.s3 && !st.s4 && !st.s5 && !st.s6 && !st.s7 &&
             tagEmpty;
    }

    function clampNonNeg(n){ return n < 0 ? 0 : n; }

    // ========= REFRESH (sempre animado, sem "duplicar infos") =========
    let refreshTimer = null;
    let refreshSeq = 0;

    async function refreshAll(reason=''){
      const seq = ++refreshSeq;
      const tasks = [loadCards(), loadUserEditsPie(), loadStatusPie()];
      const results = await Promise.allSettled(tasks);
      if(seq !== refreshSeq) return; // descarta refresh atrasado
      // silencia erros (j√° damos console.warn dentro)
      return results;
    }

    function scheduleRefresh(ms=200){
      clearTimeout(refreshTimer);
      refreshTimer = setTimeout(()=> refreshAll('scheduled'), ms);
    }

    // ========= AUTH =========
    async function updateSessionUI(){
      const { data: { session } } = await supabase.auth.getSession();
      currentUserEmail = session?.user?.email || null;

      const logged = !!session;
      authCard.classList.toggle('hidden', logged);
      dashboard.classList.toggle('hidden', !logged);
      logoutBtn.classList.toggle('hidden', !logged);

      if (logged) {
        await loadPage();
        await refreshAll('login');
      }
    }

    loginBtn.addEventListener('click', async ()=>{
      authMsg.classList.add('hidden'); authMsg.textContent='';
      const e = (emailEl.value || '').trim();
      const p = passEl.value || '';
      if(!e || !p){
        authMsg.textContent='Preencha email e senha.';
        authMsg.classList.remove('hidden');
        return;
      }
      const { error } = await supabase.auth.signInWithPassword({ email: e, password: p });
      if(error){
        authMsg.textContent = error.message || 'Falha ao entrar.';
        authMsg.classList.remove('hidden');
        return;
      }
      await updateSessionUI();
    });

    logoutBtn.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      await updateSessionUI();
    });

    await updateSessionUI();

    // ========= CARDS =========
    async function loadCards(){
      try{
        const qCount = applyFilters(supabase.from(TABLE).select('*', { count:'exact', head:true }));
        const { count: totalCount } = await qCount;
        cardTotal.textContent = totalCount || 0;

        const qOn = applyFilters(supabase.from(TABLE).select('*',{ count:'exact', head:true })).eq('online', true);
        const { count: onCount } = await qOn;
        cardOnline.textContent = onCount || 0;

        const qVal = applyFilters(supabase.from(TABLE).select('*',{ count:'exact', head:true })).eq('f3','valid');
        const { count: valCount } = await qVal;
        cardValid.textContent = valCount || 0;

        try{
          const s = (searchEl.value || '').trim();
          const onlyValid = (validFilterEl.value === 'yes');
          const { data: sumData, error: sumErr } = await supabase.rpc('sum_wcoin_filtered', { _search: s || null, _only_valid: onlyValid });
          cardWSum.textContent = sumErr ? '‚Äì' : fmt(sumData || 0);
        }catch(_e){
          cardWSum.textContent = '‚Äì';
        }
      }catch(err){
        console.warn('loadCards error:', err);
      }
    }

    // ========= PIE AZUL (user edits) =========
    function renderUserChartFromRows(rowsArr){
      const top = (rowsArr || []).slice().sort((a,b)=> (b.value||0)-(a.value||0)).slice(0,4);

      const labels = top.map(r => r.label);            // ‚úÖ labels fixos (sem n√∫meros)
      const values = top.map(r => Number(r.value||0)); // ‚úÖ valores no dataset
      const total = (rowsArr || []).reduce((a,r)=> a + Number(r.value||0), 0);

      pieTotalEditsLbl.textContent = `${fmt(total)} altera√ß√µes`;

      const colors = ['#38bdf8','#fb7185','#fb923c','#fbbf24'];
      const ctx = userPieCanvas.getContext('2d');

      if(userChart){
        userChart.data.labels = labels;
        userChart.data.datasets[0].data = values;
        userChart.update(); // anima
      } else {
        userChart = new Chart(ctx, {
          type:'pie',
          data:{
            labels,
            datasets:[{
              data: values,
              backgroundColor: colors,
              borderColor:'#000',
              borderWidth:2
            }]
          },
          options:{
            responsive:false,
            maintainAspectRatio:false,
            radius:'90%',
            animation:{ duration:520, easing:'easeOutQuart' },
            plugins:{
              legend:{ display:false },
              tooltip:{
                callbacks:{
                  label:(tt)=> `${labels[tt.dataIndex]}: ${fmt(values[tt.dataIndex])}`
                }
              }
            }
          }
        });
      }

      // legenda custom (com n√∫meros)
      if(userLegend){
        userLegend.innerHTML = '';
        labels.forEach((lab,i)=>{
          const item = document.createElement('div');
          item.className = 'chart-legend-item';
          item.innerHTML = `
            <span class="chart-legend-color" style="background:${colors[i]};"></span>
            <span title="${lab}">${lab} (${fmt(values[i])})</span>
          `;
          userLegend.appendChild(item);
        });
      }
    }

    async function loadUserEditsPie(){
      if(!userPieCanvas) return;
      try{
        const { data, error } = await supabase.rpc('get_update_stats');
        if(error){ console.warn('get_update_stats:', error.message); return; }

        const arr = Array.isArray(data) ? data : [];
        lastUserRows = arr.map(r => ({
          label: (r.user_email || (r.user_id ?? 'sem email')),
          value: Number(r.total_edits || r.total || 0)
        }));
        renderUserChartFromRows(lastUserRows);
      }catch(err){
        console.warn('loadUserEditsPie error:', err);
      }
    }

    function optimisticUserEditsBump(){
      if(!currentUserEmail) return;
      const rowsArr = Array.isArray(lastUserRows) ? lastUserRows.slice() : [];
      const idx = rowsArr.findIndex(r => r.label === currentUserEmail);
      if(idx >= 0) rowsArr[idx] = { ...rowsArr[idx], value: Number(rowsArr[idx].value||0) + 1 };
      else rowsArr.push({ label: currentUserEmail, value: 1 });
      lastUserRows = rowsArr;
      renderUserChartFromRows(lastUserRows);
    }

    // ========= PIE ROXO (status) =========
    function statusVisualValues(real){
      const otherSum = real.online + real.itens + real.rapelado;
      let validasVisual = real.validas;
      if (real.validas > 0 && otherSum > 0) {
        const targetValidas = otherSum * (70/30);
        if (real.validas > targetValidas) validasVisual = targetValidas;
      }
      const minIfNonZero = 0.25;
      return [
        real.online > 0 ? Math.max(minIfNonZero, real.online) : 0,
        real.itens > 0 ? Math.max(minIfNonZero, real.itens) : 0,
        real.rapelado > 0 ? Math.max(minIfNonZero, real.rapelado) : 0,
        validasVisual > 0 ? Math.max(minIfNonZero, validasVisual) : 0,
      ];
    }

    function renderStatusChart(real){
      const names = ['Online','Itens Pegar','Rapelado','V√°lidas limpas']; // ‚úÖ labels fixos
      const colors = ['#a78bfa','#ec4899','#fb7185','#4c1d95'];

      const totalReal = real.online + real.itens + real.rapelado + real.validas;
      statusTotalLbl.textContent = `${fmt(totalReal)} registros`;
      validasLimpasLbl.textContent = fmt(real.validas);

      const valuesVisual = statusVisualValues(real);
      const ctx = statusCanvas.getContext('2d');

      if(statusChart){
        statusChart.data.labels = names;
        statusChart.data.datasets[0].data = valuesVisual;
        statusChart.update(); // anima
      } else {
        statusChart = new Chart(ctx, {
          type:'pie',
          data:{
            labels: names,
            datasets:[{
              data: valuesVisual,
              backgroundColor: colors,
              borderColor:'#000',
              borderWidth:2
            }]
          },
          options:{
            responsive:false,
            maintainAspectRatio:false,
            radius:'90%',
            animation:{ duration:520, easing:'easeOutQuart' },
            plugins:{
              legend:{ display:false },
              tooltip:{
                callbacks:{
                  label:(tt)=>{
                    const realVals = [real.online, real.itens, real.rapelado, real.validas];
                    return `${names[tt.dataIndex]}: ${fmt(realVals[tt.dataIndex])}`;
                  }
                }
              }
            }
          }
        });
      }

      // legenda custom com n√∫meros (dentro do card)
      if(statusLegend){
        const counts = [real.online, real.itens, real.rapelado, real.validas];
        statusLegend.innerHTML = '';
        names.forEach((name,i)=>{
          const lab = `${name} (${fmt(counts[i])})`;
          const item = document.createElement('div');
          item.className = 'chart-legend-item';
          item.innerHTML = `
            <span class="chart-legend-color" style="background:${colors[i]};"></span>
            <span title="${lab}">${lab}</span>
          `;
          statusLegend.appendChild(item);
        });
      }
    }

    async function loadStatusPie(){
      if(!statusCanvas) return;
      try{
        const { data, error } = await supabase.rpc('get_status_distribution');
        if(error){ console.warn('get_status_distribution:', error.message); return; }
        if(!data || !data[0]) return;

        const d = data[0];
        lastStatusReal = {
          online: Number(d.online || 0),
          itens: Number(d.itens_pegar || 0),
          rapelado: Number(d.rapelado || 0),
          validas: Number(d.validas_limpas || 0),
        };
        renderStatusChart(lastStatusReal);
      }catch(err){
        console.warn('loadStatusPie error:', err);
      }
    }

    function optimisticStatusAdjust(tr, patch){
      // S√≥ vale se j√° temos status carregado
      if(!lastStatusReal) return;

      const before = getRowStateFromTr(tr);
      const after = { ...before, ...patch };

      // status do SQL considera apenas f3='valid'
      if(before.f3 !== 'valid'){
        applyRowStateToTr(tr, after);
        return;
      }

      const beforeL = isValidasLimpas(before);
      const afterL = isValidasLimpas(after);

      lastStatusReal.online   = clampNonNeg(lastStatusReal.online   + ((after.online?1:0) - (before.online?1:0)));
      lastStatusReal.itens    = clampNonNeg(lastStatusReal.itens    + ((after.flag?1:0)   - (before.flag?1:0)));
      lastStatusReal.rapelado = clampNonNeg(lastStatusReal.rapelado + ((after.olhar?1:0)  - (before.olhar?1:0)));
      lastStatusReal.validas  = clampNonNeg(lastStatusReal.validas  + ((afterL?1:0)       - (beforeL?1:0)));

      applyRowStateToTr(tr, after);
      renderStatusChart(lastStatusReal);
    }

    // ========= TABELA =========
    // ---------- √çCONES (reuso em tabela e parentesco) ----------
    function renderRows(items){
      const ICON_KIN_SVG = '<svg class=\"icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"11\" cy=\"11\" r=\"7\"/><path d=\"M21 21l-4.3-4.3\"/></svg>';
      const ICON_SPIN_SVG = '<svg class="icon mh-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-3.2-6.9"/><path d="M21 3v6h-6"/></svg>';

      
      rowsEl.innerHTML = (items || []).map(r => {
        const sCells = [1,2,3,4,5,6,7].map(n =>
          `<td class="px-3 py-2 text-center"><input type="checkbox" class="sChk cbfx" data-s="${n}" ${r['s'+n] ? 'checked' : ''}/></td>`
        ).join('');

        return `
          <tr class="hover:bg-zinc-900/60 transition" data-id="${r.id}"
              data-f3="${(r.f3 ?? '')}"
              data-online="${r.online ? '1':'0'}"
              data-flag="${r.flag ? '1':'0'}"
              data-olhar="${r.olhar ? '1':'0'}"
              data-tag4="${(r.tag4 ?? '')}"
              data-s1="${r.s1 ? '1':'0'}" data-s2="${r.s2 ? '1':'0'}" data-s3="${r.s3 ? '1':'0'}"
              data-s4="${r.s4 ? '1':'0'}" data-s5="${r.s5 ? '1':'0'}" data-s6="${r.s6 ? '1':'0'}" data-s7="${r.s7 ? '1':'0'}"
          >
            <td class="px-3 py-2 whitespace-nowrap font-medium">
              <div class="flex items-center gap-2">
                <span class="text-xs text-zinc-500">${formatDate(r.inserted_at)}</span>
                
                <button class="iconbtn kinBtn" data-open="0" title="Parentesco" data-kin="1">${ICON_KIN_SVG}</button>
<span class="text-zinc-600">‚îä</span>
                <span class="uval">${(r.f1 ?? '')}</span>
                <button class="iconbtn copyBtn" title="Copiar usu√°rio" data-copy="${encodeURIComponent(r.f1 ?? '')}">${ICON_COPY_SVG}</button>
              </div>
            </td>
            <td class="px-3 py-2 whitespace-nowrap">
              <div class="flex items-center gap-2">
                <span class="pval">${(r.f2 ?? '')}</span>
                <button class="iconbtn copyBtn" title="Copiar senha" data-copy="${encodeURIComponent(r.f2 ?? '')}">${ICON_COPY_SVG}</button>
              </div>
            </td>
            <td class="px-3 py-2 whitespace-nowrap">${(r.wcoin_int ?? 0)}</td>
            <td class="px-3 py-2 whitespace-nowrap">
              <label class="switch">
                <input type="checkbox" class="onlineToggle" ${r.online ? 'checked' : ''}>
                <span class="slider"></span>
              </label>
            </td>
            <td class="px-3 py-2 whitespace-nowrap">
              <div class="flex items-center gap-2">
                <label class="switch">
                  <input type="checkbox" class="flagToggle" ${r.flag ? 'checked' : ''}>
                  <span class="slider"></span>
                </label>
                <input class="tagInput tagbox rounded border border-zinc-800 bg-zinc-950 px-2 py-1 outline-none focus:ring-2 focus:ring-zinc-700"
                       maxlength="16" value="${r.tag4 ? r.tag4 : ''}" placeholder="TAG">
              </div>
            </td>
            <td class="px-3 py-2 text-center"><input type="checkbox" class="olharToggle cbfx" ${r.olhar ? 'checked' : ''}/></td>
            ${sCells}
            <td class="px-3 py-2 whitespace-nowrap text-center">
              <button class="delBtn ml-2 px-2 py-1.5 rounded-xl bg-red-600 hover:bg-red-700 transition">Excluir</button>
            </td>
          </tr>`;
      }).join('');
    }

    async function loadPage(){
      const limit = parseInt(limitSel.value,10) || 50;
      const from = (page-1)*limit;
      const to = from + limit - 1;

      await loadCards();

      let q = baseSelect();
      q = applyFilters(q);
      q = applySort(q);
      q = q.range(from, to);

      const { data, error } = await q;
      if(error){
        rowsEl.innerHTML = `<tr><td class='px-3 py-2 text-red-500'>${error.message}</td></tr>`;
        return;
      }
      renderRows(data || []);
      pageLbl.textContent = `P√°gina ${page}`;
    }

    // ========= MENU "RECENTES" =========
    function closeRecentMenu(){ recentMenu?.classList.add('hidden'); }

    recentBtn?.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      recentMenu?.classList.toggle('hidden');
    });

    recentMenu?.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-range]');
      if(!btn) return;
      const range = btn.getAttribute('data-range') || 'all';
      if(timeRangeEl) timeRangeEl.value = range;

      const labelMap = { '24h':'24h', '7d':'7d', '30d':'30d', 'all':'Recentes' };
      if(recentLabel) recentLabel.textContent = labelMap[range] || 'Recentes';

      sort = { field:'inserted_at', asc:false };
      hintW.textContent='‚áÖ'; hintO.textContent='‚áÖ'; hintF.textContent='‚áÖ'; hintOlhar.textContent='‚áÖ';
      page = 1;

      closeRecentMenu();
      await loadPage();
      scheduleRefresh(0);
    });

    document.addEventListener('click', (e)=>{
      if(!recentMenu) return;
      if(recentMenu.classList.contains('hidden')) return;
      if(!recentMenu.contains(e.target) && !recentBtn.contains(e.target)) closeRecentMenu();
    });

    // ========= A√á√ïES (delega√ß√£o) =========
    rowsEl.addEventListener('click', async (e)=>{
      // Copiar (tabela principal + tabela de parentesco)
      const copyBtn = e.target.closest('.copyBtn, .copyUserBtn, .copyPassBtn');
      if(copyBtn){
        e.preventDefault();
        e.stopPropagation();
        const raw = copyBtn.getAttribute('data-copy') || '';
        if(!raw) return;
        let txt = raw;
        try{ txt = decodeURIComponent(raw); }catch(_e){}
        try{
          await navigator.clipboard.writeText(txt);
        }catch(_err){
          // fallback (caso clipboard API esteja bloqueada)
          const ta = document.createElement('textarea');
          ta.value = txt;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          try{ document.execCommand('copy'); }catch(_e){}
          ta.remove();
        }
        return;
      }

      // Parentesco (lupa)
      const kinBtn = e.target.closest('.kinBtn');
      if(kinBtn){
        const tr = kinBtn.closest('tr[data-id]');
        if(tr) await toggleKinshipRow(tr);
        return;
      }

      // Excluir
      const delBtn = e.target.closest('.delBtn');
      if(delBtn){
        const tr = delBtn.closest('tr[data-id]');
        if(!tr) return;
        const id = tr.getAttribute('data-id');
        const user = tr.querySelector('.uval')?.textContent?.trim() || '';
        if(!confirm(`Excluir este registro?\n\n${user ? 'Usu√°rio: ' + user + '\n' : ''}ID: ${id}`)) return;

        const { error } = await supabase.from(TABLE).delete().eq('id', id);
        if(error){
          console.warn('delete error:', error.message);
          alert('Erro ao excluir: ' + (error.message || ''));
          return;
        }

        // remove a linha e qualquer parentesco aberto logo abaixo
        const next = tr.nextElementSibling;
        if(next && next.classList.contains('kinshipRow')) next.remove();
        tr.remove();

        scheduleRefresh(0);
        return;
      }
    });

    rowsEl.addEventListener('change', async (e)=>{
      const tr = e.target.closest('tr[data-id]');
      if(!tr) return;
      const id = tr.getAttribute('data-id');

      const isOnline = e.target.classList.contains('onlineToggle');
      const isFlag = e.target.classList.contains('flagToggle');
      const isOlhar = e.target.classList.contains('olharToggle');
      const isS = e.target.classList.contains('sChk');
      const isTag = e.target.classList.contains('tagInput');
      if(isTag) return;

      let patch = null;
      if(isOnline) patch = { online: e.target.checked };
      else if(isFlag) patch = { flag: e.target.checked };
      else if(isOlhar) patch = { olhar: e.target.checked };
      else if(isS){
        const n = e.target.getAttribute('data-s');
        patch = { ['s'+n]: e.target.checked };
      }
      if(!patch) return;

      // ‚úÖ UPDATE IMEDIATO (otimista) COM ANIMA√á√ÉO
      optimisticUserEditsBump();
      optimisticStatusAdjust(tr, patch);

      const { error } = await supabase.from(TABLE).update(patch).eq('id', id);
      if(error) console.warn('update error:', error.message);

      // ‚úÖ Confirma no servidor (corrige caso RLS/trigger altere algo)
      scheduleRefresh(150);
    });

    rowsEl.addEventListener('focusout', async (e)=>{
      const input = e.target.closest('.tagInput');
      if(!input) return;
      const tr = input.closest('tr[data-id]');
      if(!tr) return;
      const id = tr.getAttribute('data-id');
      const val = (input.value || '').trim();

      // ‚úÖ otimista (tag mexe em "v√°lidas limpas" e conta como modifica√ß√£o)
      optimisticUserEditsBump();
      optimisticStatusAdjust(tr, { tag4: val || '' });

      const { error } = await supabase.from(TABLE).update({ tag4: val || null }).eq('id', id);
      if(error) console.warn('tag update error:', error.message);

      scheduleRefresh(150);
    });

    // ========= PAGINA√á√ÉO =========
    applyBtn.addEventListener('click', async ()=>{ page = 1; await loadPage(); scheduleRefresh(0); });
    prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; loadPage(); } });
    nextBtn.addEventListener('click', ()=>{ page++; loadPage(); });
    limitSel.addEventListener('change', ()=>{ page = 1; loadPage(); });

    // ========= SORT =========
    function resetHints(){ hintW.textContent='‚áÖ'; hintO.textContent='‚áÖ'; hintF.textContent='‚áÖ'; hintOlhar.textContent='‚áÖ'; }

    thWcoin.addEventListener('click', ()=>{
      if(sort.field !== 'wcoin_int') sort = { field:'wcoin_int', asc:false };
      else sort.asc = !sort.asc;
      resetHints(); hintW.textContent = sort.asc ? '‚Üë' : '‚Üì';
      page = 1; loadPage();
    });
    thOnline.addEventListener('click', ()=>{
      if(sort.field !== 'online') sort = { field:'online', asc:false };
      else sort.asc = !sort.asc;
      resetHints(); hintO.textContent = sort.asc ? '‚Üë' : '‚Üì';
      page = 1; loadPage();
    });
    thFlag.addEventListener('click', ()=>{
      if(sort.field !== 'flag') sort = { field:'flag', asc:false };
      else sort.asc = !sort.asc;
      resetHints(); hintF.textContent = sort.asc ? '‚Üë' : '‚Üì';
      page = 1; loadPage();
    });
    thOlhar.addEventListener('click', ()=>{
      if(sort.field !== 'olhar') sort = { field:'olhar', asc:false };
      else sort.asc = !sort.asc;
      resetHints(); hintOlhar.textContent = sort.asc ? '‚Üë' : '‚Üì';
      page = 1; loadPage();
    });

    // ========= REALTIME =========
    try{
      supabase.channel('realtime:webzen_cache_raw_ui')
        .on('postgres_changes', { event:'UPDATE', schema:'public', table: TABLE }, () => scheduleRefresh(200))
        .on('postgres_changes', { event:'INSERT', schema:'public', table: TABLE }, () => scheduleRefresh(200))
        .subscribe();
    }catch(err){
      console.warn('Realtime indispon√≠vel:', err);
    }
  </script>
</body>
</html>
